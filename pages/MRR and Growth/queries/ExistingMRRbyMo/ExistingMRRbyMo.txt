SELECT
  DATE_FORMAT(first_day, '%Y-%m') AS month,
  COUNT(DISTINCT subscriptions.id) AS subscriptions,
  ROUND( SUM(
    CASE
      WHEN subscriptions.created >= DATE_SUB(subscriptions.created, INTERVAL 12 MONTH) THEN
        subscriptions.initial_amount / 12
      ELSE
        subscriptions.recurring_amount / 12
    END
  ), 2 ) AS mrr
FROM
  (
    SELECT
      DISTINCT id,
      created,
      expiration,
			initial_amount,
			recurring_amount,
			parent_payment_id
    FROM
      wp_edd_subscriptions
  ) AS subscriptions
  JOIN (
    SELECT
      DATE_FORMAT(NOW(), '%Y-%m-01') AS first_day
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 1 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 2 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 3 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 4 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 5 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 6 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 7 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 8 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 9 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 10 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 11 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 12 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 13 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 14 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 15 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 16 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 17 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 18 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 19 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 20 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 21 MONTH), '%Y-%m-01')
		UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 22 MONTH), '%Y-%m-01')
    UNION ALL
    SELECT
      DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 23 MONTH), '%Y-%m-01')
  ) AS months
	ON
  (subscriptions.created < months.first_day AND
  (subscriptions.expiration >= months.first_day))
WHERE
  NOT EXISTS (
    SELECT
      1
    FROM
      wp_edd_orders
    WHERE
      ( parent = subscriptions.parent_payment_id OR id = subscriptions.parent_payment_id )
			AND status = 'refunded'
  )
GROUP BY
  month;